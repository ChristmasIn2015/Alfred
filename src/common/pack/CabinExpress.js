var P=Object.create,c=Object.defineProperty,w=Object.getPrototypeOf,S=Object.prototype.hasOwnProperty,p=Object.getOwnPropertyNames,y=Object.getOwnPropertyDescriptor;var m=s=>c(s,"__esModule",{value:!0});var C=(s,e)=>{for(var t in e)c(s,t,{get:e[t],enumerable:!0})},D=(s,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of p(e))!S.call(s,i)&&i!=="default"&&c(s,i,{get:()=>e[i],enumerable:!(t=y(e,i))||t.enumerable});return s},h=s=>s&&s.__esModule?s:D(m(c(s!=null?P(w(s)):{},"default",{value:s,enumerable:!0})),s);m(exports);C(exports,{default:()=>T});var g=h(require("mongodb")),u=class{constructor(e){this.DBAddress="";this.DBOrigin=null;this.DBAddress=e}start(){return new Promise((e,t)=>{g.MongoClient.connect(this.DBAddress,{useUnifiedTopology:!0},(i,n)=>{i?t(i):(this.DBOrigin=n.db(this.DBAddress.split("/").reverse()[0]),e(!0))})})}getTableCaller(e){return new Promise((t,i)=>{this.DBOrigin.collection(e,{strict:!0},(n,r)=>{n?n.message===`Collection ${e} does not exist. Currently in strict mode.`?this.DBOrigin.createCollection(e,{},(a,o)=>{if(a){i(`\u521B\u5EFA\u96C6\u5408${e}\u5931\u8D25: ${a.message}`);return}t(o)}):i(n):t(r)})})}},f=u;var O=h(require("mongodb")),b=class{constructor(e){this.TableName=null;this.TableStruct=null;this.TableCaller=null;this.TableCaller=e}async init(e,t){this.TableName=e,this.TableStruct=Object.assign({},t);for(let n in this.TableStruct)this.TableStruct[n]=null;let i=await this.getOldStruct();for(let n in t){if(n==="id"||n==="_id"||n==="timeCreate"||n==="timeUpdate"||i[n])continue;let r={};r[n]=null,await this.TableCaller.updateMany({},{$set:r})}for(let n in i){if(n==="id"||n==="_id"||n==="timeCreate"||n==="timeUpdate"||t[n])continue;let r={};r[n]=null,await this.TableCaller.updateMany({},{$unset:r})}}async create(e){e=this.model2TableStruct(e);let t=Date.now();return e=Object.assign(e,{_id:String(new O.ObjectId),timeCreate:t,timeUpdate:t}),(await this.TableCaller.insertOne(e,{forceServerObjectId:!0})).ops[0]}get(e){return new Promise((t,i)=>{this.TableCaller.find(e).toArray((n,r)=>{n?i(n.message):t(r[0]||null)})})}query(e){return new Promise((t,i)=>{this.TableCaller.find(e).toArray((n,r)=>{n?i(n.message):t(r)})})}async update(e,t){let i=this.getStruct();for(let r in t)r==="_id"||r==="timeCreate"||r==="timeUpdate"||i[r]===void 0&&delete t[r];return t=Object.assign(t,{timeUpdate:Date.now()}),await this.TableCaller.updateMany(e,{$set:t})}async delete(e){if((await this.TableCaller.deleteOne({_id:e})).deletedCount!==1)throw new Error(`${e} \u4E0D\u5B58\u5728`);return!0}async getOldStruct(){let e=await this.get({});for(let t in e)e[t]=!0;return e||{}}getStruct(){return Object.assign({},this.TableStruct)}model2TableStruct(e){let t=this.getStruct()||{};for(let i in t)e[i]&&(t[i]=e[i]);return t}},E=b;var d=class{constructor(){this.VUE_PATH=require("path").join(process.cwd(),"./src/web/dist");this.BinderMap=new Map;this.cabinDB=null;this.cabinHandler=null;this.cabinInfo=null;this.BODY_PARSE=require("body-parser");this.EXPRESS=require("express");this.EXPRESS_PROXY=require("http-proxy-middleware").createProxyMiddleware;this.NODE_WEBSOCKET=require("nodejs-websocket");this.NODE_WEBSOCKET_ConnectionMAP={};this.NODE_WEBSOCKET_OrderMAP={}}async dbLink(e){this.cabinDB=new f(e),await this.cabinDB.start()}async dbTabler(e){if(global.$db||(global.$db={}),!this.cabinDB)throw new Error("\u6570\u636E\u5E93\u670D\u52A1\u4E0D\u5B58\u5728");for(let t in e){let i=e[t].name,n=await this.cabinDB.getTableCaller(i);global.$db[i]=new E(n),await global.$db[i].init(i,e[t].struct)}}express(e,t){this.cabinInfo={CabinHandler:"express",APP_NAME:t,IPv4:global.$common.getIPv4(),SOCKET_NUMBER:e},e&&(this.cabinHandler=this.EXPRESS(),this.cabinHandler.all("*",(i,n,r)=>{n.header("Access-Control-Allow-Origin","*"),n.header("Access-Control-Allow-Headers","*"),n.header("Access-Control-Allow-Methods","*"),r()}),this.cabinHandler.use(this.EXPRESS.static(this.VUE_PATH)),this.cabinHandler.listen(e,"0.0.0.0"))}expressProxy(e,t,i){i=!!i;let n={target:t,changeOrigin:!0,ws:i};this.cabinHandler.use(e,this.EXPRESS_PROXY(n))}expressHtml(e,t){!this.cabinInfo.SOCKET_NUMBER||this.cabinHandler.get(e,(i,n)=>n.sendFile(t))}expressRoute(e,t,i){if(!!this.cabinInfo.SOCKET_NUMBER)switch(e){case"GET":this.cabinHandler.get(t,(n,r)=>i(n,r));break;case"POST":this.cabinHandler.post(t,this.BODY_PARSE.json(),(n,r)=>i(n,r));break}}websocket(e,t){return this.cabinInfo={CabinHandler:"websocket",APP_NAME:t,IPv4:global.$common.getIPv4(),SOCKET_NUMBER:e},new Promise((i,n)=>{if(!e){n(`\u8BF7\u9009\u62E9\u7AEF\u53E3\u53F7:${e}`);return}this.cabinHandler=this.NODE_WEBSOCKET.createServer(r=>{let a=r.key;this.NODE_WEBSOCKET_ConnectionMAP[a]=r,r.on("text",async o=>{try{if(typeof o!="string")return;o=JSON.parse(o),o.connectionKey=a;let l=this.NODE_WEBSOCKET_OrderMAP[o.orderName];if(!o.orderName||!l)return;await l(o)}catch(l){this.websocketAnswer({connectionKey:a,orderName:`${o.orderName}/error`,DTO:l.message})}}),r.on("close",o=>{delete this.NODE_WEBSOCKET_ConnectionMAP[a],this.websocketAnswer({connectionKey:a,orderName:"/connection/close",DTO:"\u670D\u52A1\u5DF2\u5173\u95ED"})}),r.on("error",o=>{delete this.NODE_WEBSOCKET_ConnectionMAP[a]}),this.websocketAnswer({connectionKey:a,orderName:"/connection/success",DTO:null})}),this.cabinHandler.listen(e),i(!0)})}websocketRoute(e,t){!e||(this.NODE_WEBSOCKET_OrderMAP[e]=t)}websocketAnswer(e){let t=this.NODE_WEBSOCKET_ConnectionMAP[e.connectionKey];!t||t.sendText(JSON.stringify(e))}websocketBoardCast(e){}},T=d;
