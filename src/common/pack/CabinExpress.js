var y=Object.create,s=Object.defineProperty,D=Object.getPrototypeOf,C=Object.prototype.hasOwnProperty,w=Object.getOwnPropertyNames,B=Object.getOwnPropertyDescriptor;var d=l=>s(l,"__esModule",{value:!0});var j=(l,e)=>{d(l);for(var t in e)s(l,t,{get:e[t],enumerable:!0})},O=(l,e,t)=>{if(d(l),e&&typeof e=="object"||typeof e=="function")for(let r of w(e))!C.call(l,r)&&r!=="default"&&s(l,r,{get:()=>e[r],enumerable:!(t=B(e,r))||t.enumerable});return l},a=l=>l&&l.__esModule?l:O(s(l!=null?y(D(l)):{},"default",{value:l,enumerable:!0}),l);j(exports,{default:()=>P});var f=a(require("mongodb")),o=class{constructor(e){this.DBAddress="";this.DBOrigin=null;this.DBAddress=e}start(){return new Promise((e,t)=>{f.MongoClient.connect(this.DBAddress,{useUnifiedTopology:!0},(r,i)=>{r?t(r):(this.DBOrigin=i.db(this.DBAddress.split("/").reverse()[0]),e(!0))})})}getTableCaller(e){return new Promise((t,r)=>{this.DBOrigin.collection(e,{strict:!0},(i,n)=>{i?i.message===`Collection ${e} does not exist. Currently in strict mode.`?this.DBOrigin.createCollection(e,{},(m,T)=>{if(m){r(`\u521B\u5EFA\u96C6\u5408${e}\u5931\u8D25: ${m.message}`);return}t(T)}):r(i):t(n)})})}},g=o;var h=a(require("mongodb")),c=class{constructor(e){this.TableName=null;this.TableStruct=null;this.TableCaller=null;this.TableCaller=e}async init(e,t){this.TableName=e,this.TableStruct=Object.assign({},t);for(let i in this.TableStruct)this.TableStruct[i]=null;let r=await this.getOldStruct();for(let i in t){if(i==="id"||i==="_id"||i==="timeCreate"||i==="timeUpdate"||r[i])continue;let n={};n[i]=null,console.log("create",i),await this.TableCaller.updateMany({},{$set:n})}for(let i in r){if(i==="id"||i==="_id"||i==="timeCreate"||i==="timeUpdate"||t[i])continue;let n={};n[i]=null,console.log("delete",i),await this.TableCaller.updateMany({},{$unset:n})}}async create(e){e=this.model2TableStruct(e);let t=Date.now();return e=Object.assign(e,{_id:String(new h.ObjectId),timeCreate:t,timeUpdate:t}),(await this.TableCaller.insertOne(e,{forceServerObjectId:!0})).ops[0]}get(e){return new Promise((t,r)=>{this.TableCaller.find(e).toArray((i,n)=>{i?r(i.message):t(n[0]||null)})})}query(e){return new Promise((t,r)=>{this.TableCaller.find(e).toArray((i,n)=>{i?r(i.message):t(n)})})}async update(e,t){let r=this.getStruct();for(let n in t)n==="_id"||n==="timeCreate"||n==="timeUpdate"||r[n]===void 0&&delete t[n];return t=Object.assign(t,{timeUpdate:Date.now()}),await this.TableCaller.updateMany(e,{$set:t})}async delete(e){if((await this.TableCaller.deleteOne({_id:e})).deletedCount!==1)throw new Error(`${e} \u4E0D\u5B58\u5728`);return!0}async getOldStruct(){let e=await this.get({});for(let t in e)e[t]=!0;return e||{}}getStruct(){return Object.assign({},this.TableStruct)}model2TableStruct(e){let t=this.getStruct()||{};for(let r in t)e[r]&&(t[r]=e[r]);return t}},p=c;var u=a(require("express")),b=class{constructor(){this.cabinDB=null;this.cabinInfo=null;this.cabinHandler=null;this.OriginMap=new Map}async dbLink(e){this.cabinDB=new g(e),await this.cabinDB.start()}async dbTabler(e){if(global.$db||(global.$db={}),!this.cabinDB)throw new Error("\u6570\u636E\u5E93\u670D\u52A1\u4E0D\u5B58\u5728");for(let t in e){let r=e[t].name,i=await this.cabinDB.getTableCaller(r);global.$db[r]=new p(i),await global.$db[r].init(r,e[t].struct)}}express(e,t){this.cabinInfo={CabinHandler:"express",APP_NAME:t,IPv4:global.$common.getIPv4(),SOCKET_NUMBER:e},e&&(this.cabinHandler=u.default(),this.cabinHandler.all("*",(r,i,n)=>{i.header("Access-Control-Allow-Origin","*"),i.header("Access-Control-Allow-Headers","*"),i.header("Access-Control-Allow-Methods","*"),n()}),this.cabinHandler.listen(e,"0.0.0.0"))}expressRoute(e,t,r){this.cabinInfo.SOCKET_NUMBER&&(e==="GET"&&this.cabinHandler.get(t,(i,n)=>r(i,n)),e==="POST"&&this.cabinHandler.post(t,require("body-parser").json(),(i,n)=>r(i,n)))}expressHtml(e,t,r){this.cabinInfo.SOCKET_NUMBER&&(this.cabinHandler.use(u.default.static(t)),this.cabinHandler.get(e,(i,n)=>n.sendFile(r)))}},P=b;
