var J=Object.create,T=Object.defineProperty,ee=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty,le=Object.getOwnPropertyNames,x=Object.getOwnPropertyDescriptor;var oe=i=>T(i,"__esModule",{value:!0});var ne=(i,t,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let l of le(t))!te.call(i,l)&&l!=="default"&&T(i,l,{get:()=>t[l],enumerable:!(e=x(t,l))||e.enumerable});return i},ae=i=>i&&i.__esModule?i:ne(oe(T(i!=null?J(ee(i)):{},"default",{value:i,enumerable:!0})),i),u=(i,t,e,l)=>{for(var n=l>1?void 0:l?x(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(l?a(t,e,n):a(n))||n);return l&&n&&T(t,e,n),n};var w=class{constructor(){this.isDebug=!0}toggleDebug(){this.isDebug=!this.isDebug}async log(t){try{this.isDebug&&await global.$common.fetch("http://wqao.top/yjy-log/create","POST",{message:t})}catch(e){console.log(e)}}},I=w;var y=ae(require("axios")),q;(function(i){i.GET="GET",i.POST="POST"})(q||(q={}));var _=class{constructor(t,e){this.BASE_URL=t;this.COMPLETE=e;this.DEFAULT_HEADER={};this.BASE_URL=t,this.COMPLETE=e}async request(t,e,l,n){try{let o=await y.default({method:t,url:this.BASE_URL+(e||""),data:l,headers:n||this.DEFAULT_HEADER||{}});return await this.COMPLETE(o.data)}catch(o){throw o}}},D=class{constructor(){}getRequester(t,e){return new _(t,e)}async fetch(t,e,l,n){return(await y.default({method:e,url:t,data:l,headers:n})).data}},N=D;var E=class{constructor(){}getTimeDTO(){return{year:"",month:"",day:"",hour:"",min:"",sec:"",full:"",week:""}}getYYMMDD(t=Date.now()){let e="";return new Date(t).toLocaleDateString().split("/").forEach(l=>e+=Number(l)<10?`/0${l}`:`/${l}`),e.replace("/","")}getYY(t=Date.now()){return new Date(t).getFullYear().toString()}getMM(t=Date.now()){let e=new Date(t).getMonth()+1;return(e<10?`0${e}`:e).toString()}getDD(t=Date.now()){let e=new Date(t).getDate();return(e<10?`0${e}`:e).toString()}getHHMMSS(t=Date.now()){let e=null,l=new Date(t);return e=this.getTimeDTO(),e.hour=l.getHours()<10?`0${l.getHours()}`:l.getHours().toString(),e.min=l.getMinutes()<10?`0${l.getMinutes()}`:l.getMinutes().toString(),e.sec=l.getSeconds()<10?`0${l.getSeconds()}`:l.getSeconds().toString(),e.full=`${e.hour}:${e.min}:${e.sec}`,e}getFullTime(t=Date.now()){let e=this.getHHMMSS(t);return e.year=new Date(t).getFullYear().toString(),e.full=`${this.getYYMMDD(t)} ${e.full}`,e}getTimeGap(t=Date.now()+864e5){let e=null,l=t-Date.now();if(l>0){e=this.getTimeDTO();let n=~~(l/1e3/60/60)%24;e.hour=n<10?`0${n}`:n.toString();let o=~~(l/1e3/60)%60;e.min=o<10?`0${o}`:o.toString();let a=~~(l/1e3)%60;e.sec=a<10?`0${a}`:a.toString(),e.full=`${e.hour}:${e.min}:${e.sec}`}return e}getChineseWeek(t=Date.now()){let e="";switch(new Date(t).getDay()){case 1:e="\u5468\u4E00";break;case 2:e="\u5468\u4E8C";break;case 3:e="\u5468\u4E09";break;case 4:e="\u5468\u56DB";break;case 5:e="\u5468\u4E94";break;case 6:e="\u5468\u516D";break;case 0:e="\u5468\u65E5";break}return e}},j=E;var C=class{constructor(){}isValidMobile(t){return/^[1][0-9]{10}$/.test(t)}isValidEmail(t){return/^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]+$/.test(t)}},U=C;var R=class{constructor(){}getLatLngDistance(t,e,l,n){let o=t*Math.PI/180,a=l*Math.PI/180,r=o-a,c=e*Math.PI/180-n*Math.PI/180,s=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(o)*Math.cos(a)*Math.pow(Math.sin(c/2),2)));return s=s*6378.137,s=Math.round(s*1e4)/1e4,s.toFixed(2)}wannaObject(t,e){return t}},H=R;var k=class{constructor(){this.BinderMap=new Map;this.bindClass(this,"Log",I),this.bindClass(this,"Requester",N),this.bindClass(this,"UtilsTime",j),this.bindClass(this,"UtilsVaild",U),this.bindClass(this,"UtilsCalculation",H)}bindClass(t,e,l){l instanceof Function&&(t.BinderMap.set(e,new l),Object.getOwnPropertyNames(l.prototype).forEach(n=>{n!=="constructor"&&(t[n]=(...o)=>{let a=t.BinderMap.get(e);return a[n].apply(a,o)})}))}};var A=class{constructor(){this.IPv4=null;this.IPv4=this.getIPv4()}AlfredLogin(){let t=this.IPv4;return(e,l,n)=>{let o=n.value;n.value=async function(...a){let r=a[0],c=a[1];try{let s=await global.$common.fetch(`http://${t}:80/alfred/user/info`,"POST",null,{authorization:r.header("authorization")});if(s.code!==200)throw new Error(`${s.message}(code:${s.code})`);await o.apply(this,a)}catch(s){c.send({code:null,data:null,message:`\u767B\u5F55\u4FE1\u606F\u5F02\u5E38: ${s.message}`})}}}}Response(t=""){return(e,l,n)=>{let o=n.value;n.value=async function(...a){let r={code:null,data:null,message:""};try{let c=await o.apply(this,a);r.code=200,r.data=c||t}catch(c){r.message=c.message||c}finally{a[1].send(r)}}}}WsAlfredLogin(){let t=this.IPv4;return(e,l,n)=>{let o=n.value;n.value=async function(...a){let r=a[0];try{let c=await global.$common.fetch(`http://${t}:80/alfred/user/info`,"POST",null,{authorization:r.DTO.authorization});if(c.code!==200)throw new Error(`${c.message}`);if(c.data._id!=="603e28cd6b57e016b0bbb9b5")throw new Error("\u60A8\u4E0D\u662F\u7BA1\u7406\u5458");await o.apply(this,a)}catch(c){r.orderName="/request/authorization",r.DTO=c.message||c||"\u60A8\u7684\u6743\u9650\u4E0D\u8DB3",global.Cabin.websocketAnswer(r)}}}}WsResponse(t="",e=!1){return(l,n,o)=>{let a=o.value;o.value=async function(...r){let c=r[0];try{let s=await a.apply(this,r);c.DTO=s||t||null}catch(s){c.orderName="/request/fail",c.DTO=s.message||s}finally{e?global.Cabin.websocketBoardCast(c):global.Cabin.websocketAnswer(c)}}}}ElectronResponse(t=""){return(e,l,n)=>{let o=n.value;n.value=async function(...a){let r={code:null,data:null,message:""};try{let c=await o.apply(this,a);r.code=200,r.data=c||t}catch(c){r.message=c.message||c}finally{return r}}}}getIPv4(){let t=null;if(global.process.platform==="win32"){let e=require("os").networkInterfaces();for(let l in e)if(l==="\u4EE5\u592A\u7F51"||l==="WLAN"){for(let n in e[l]){let o=e[l][n];if(o.family==="IPv4"){t=o.address;break}}break}}return t}printRed(t){console.log(`[41m[30m${t}[0m`)}printYellow(t){console.log(`[43m[30m${t}[0m`)}printBlue(t){console.log(`[44m[37m${t}[0m`)}printGreen(t){console.log(`[42m[30m${t}[0m`)}printLink(t){console.log(`[34m${t}[0m`)}printText(t){console.log(`[33m${t}[0m`)}},F=A;var Q=class extends k{constructor(){super();this.bindClass(this,"UtilsReactNode",F)}};global.$common=new Q;var B=class{constructor(t){this.DBAddress="";this.DBOrigin=null;this.DBAddress=t}start(){return new Promise((t,e)=>{let l=require("sqlite3").verbose();this.DBOrigin=new l.Database(this.DBAddress,n=>n?e(n):t(!0))})}getTableCaller(t){return Promise.resolve(this.DBOrigin)}},W=B;var L=class{constructor(t){this.TableName=null;this.TableStruct=null;this.TableCaller=null;this.TableCaller=t}async init(t,e){this.TableName=t,this.TableStruct=Object.assign({},e);for(let l in this.TableStruct)this.TableStruct[l]=null;return new Promise((l,n)=>{let o="id INTEGER PRIMARY KEY AUTOINCREMENT, ";for(let r in e)e[r]==="number"&&(o+=`${r} INT, `),e[r]==="string"&&(o+=`${r} VARCHAR, `);o+="timeCreate INT, ",o+="timeUpdate INT, ",o=o.substring(0,o.length-2);let a=`CREATE TABLE IF NOT EXISTS ${t} (${o});`;this.TableCaller.run(a,async r=>{if(r){n(new Error(`${r.message}, SQL: ${a}`));return}let c=await this.getOldStruct();for(let s in e)s!=="id"&&s!=="timeCreate"&&s!=="timeUpdate"&&(c[s]||await this._createColumn(s,e[s]));for(let s in c)s!=="id"&&s!=="timeCreate"&&s!=="timeUpdate"&&(e[s]||await this._deleteColumn(s));l(!0)})})}create(t){t=this.model2TableStruct(t);let e="",l="";for(let n in t)e+=`'${n}',`,l+=`'${t[n]}',`;return e+="timeCreate,",l+=`'${Date.now()}',`,e+="timeUpdate,",l+=`'${Date.now()}',`,e=e.substring(0,e.length-1),l=l.substring(0,l.length-1),new Promise((n,o)=>{let a=`INSERT INTO ${this.TableName} (${e}) VALUES (${l});`;this.TableCaller.run(a,function(r){r?o(new Error(`${r.message}, SQL: ${a}`)):n(this)})})}get(t){let e="";for(let l in t)e+=`${l}='${t[l]}', `;return e=e.substring(0,e.length-2),new Promise((l,n)=>{let o=`SELECT * FROM ${this.TableName} WHERE ${e}`;this.TableCaller.get(o,function(a,r){a&&(a=new Error(`${a.message}, SQL: ${o}`)),a?n(a):l(r||null)})})}query(t){let e="";for(let l in t)e+=`${l}='${t[l]}', `;return e=e.substring(0,e.length-2),new Promise((l,n)=>{let o=`SELECT * FROM ${this.TableName}`;t&&Object.keys(t).length&&(o+=` WHERE ${e}`),this.TableCaller.all(o,function(a,r){a&&(a=new Error(`${a.message}, SQL: ${o}`)),a?n(a):l(r)})})}update(t,e){let l=this.getStruct();for(let a in e)a==="id"||a==="timeCreate"||a==="timeUpdate"||l[a]===void 0&&delete e[a];e=Object.assign(e,{timeUpdate:Date.now()});let n="";for(let a in e)n+=`${a}='${e[a]}', `;n=n.substring(0,n.length-2);let o="";for(let a in t)o+=`${a}='${t[a]}', `;return o=o.substring(0,o.length-2),new Promise((a,r)=>{let c=`UPDATE ${this.TableName} SET ${n} WHERE ${o}`;this.TableCaller.run(c,function(s){s&&(s=new Error(`${s.message}, SQL: ${c}`)),s?r(s):a(this)})})}delete(t){return new Promise((e,l)=>{let n=`DELETE FROM ${this.TableName} WHERE id = '${t}';`;this.TableCaller.run(n,function(o){o&&(o=new Error(`${o.message}, SQL: ${n}`)),o?l(o):e(this)})})}getOldStruct(){return new Promise((t,e)=>{let l={},n=`SELECT * FROM SQLITE_MASTER WHERE TYPE='table' AND NAME='${this.TableName}';`;this.TableCaller.get(n,function(o,a){if(o){e(new Error(`${o.message}, SQL: ${n}`));return}let r=a?a.sql:null;if(r){r=r.replace(/\n/g,""),r=r.substring(r.indexOf("(")+1,r.length-1).split(",");for(let c in r){let s=r[c].trim().split(" ")[0];l[s]=!0}}t(l)})})}getStruct(){return Object.assign({},this.TableStruct)}model2TableStruct(t){let e=this.getStruct();for(let l in e)t[l]&&(e[l]=t[l]);return e}_createColumn(t,e){return e==="number"&&(e="INT"),e==="string"&&(e="VARCHAR"),new Promise((l,n)=>{let o=`ALTER TABLE ${this.TableName} ADD COLUMN ${t} ${e}`;this.TableCaller.run(o,function(a){a?n(new Error(`${a.message}, SQL: ${o}`)):l(this)})})}async _deleteColumn(t){let e=await this.getOldStruct(),l="";for(let n in e)n!==t&&(l+=`${n}, `);return l=l.substring(0,l.length-2),new Promise((n,o)=>{let a=`CREATE TABLE IF NOT EXISTS ${this.TableName}_TEMP AS SELECT ${l} FROM ${this.TableName} WHERE 1 = 1;`;this.TableCaller.run(a,r=>{if(r){o(new Error(`${r.message}, SQL: ${a}`));return}let c=`DROP TABLE IF EXISTS ${this.TableName};`;this.TableCaller.run(c,s=>{if(s){o(new Error(`${s.message}, SQL: ${c}`));return}let b=`ALTER TABLE ${this.TableName}_TEMP RENAME TO ${this.TableName};`;this.TableCaller.run(b,function(h){h?o(new Error(`${h.message}, SQL: ${b}`)):n(!0)})})})})}},Y=L;var O=class{constructor(){this.BinderMap=new Map;this.cabinDB=null;this.cabinHandler=null}async dbLink(t){this.cabinDB=new W(t),await this.cabinDB.start()}async dbTabler(t){if(global.$db||(global.$db={}),!this.cabinDB)throw new Error("\u6570\u636E\u5E93\u670D\u52A1\u4E0D\u5B58\u5728");for(let e in t){let l=t[e].name,n=await this.cabinDB.getTableCaller(l);global.$db[l]=new Y(n),await global.$db[l].init(l,t[e].struct)}}electronRoute(t,e){global.$electron.ipcMain.handle(t,(...l)=>e(...l))}electronAliveRoute(t,e){global.$electron.ipcMain.on(t,(...l)=>e(...l))}},G=O;var ie=global.$common.ElectronResponse,S=class{constructor(){}async openDevTool(t,e){return t.sender.openDevTools(),!0}};u([ie("\u6253\u5F00\u63A7\u5236\u53F0\u6210\u529F")],S.prototype,"openDevTool",1);var z=S;var d=global.$common.ElectronResponse,m=class{constructor(){}async commitArea(t,e){let l=global.$db.Area.getStruct();l.name=e.name,e.id?await global.$db.Area.update({id:e.id},l):await global.$db.Area.create(l)}async getAreaList(){return await global.$db.Area.query()}async areaDelete(t,e){await global.$db.Area.delete(e);let l=await global.$db.Relation_AreaShelf.query({areaId:e});for(let n in l){await global.$db.Shelf.delete(l[n].shelfId),await global.$db.Relation_AreaShelf.delete(l[n].id);let o=await global.$db.Relation_ShelfBook.query({shelfId:l[n].shelfId});for(let a in o)await global.$db.Book.delete(o[a].bookId),await global.$db.Relation_ShelfBook.delete(o[a].id)}}async commitShelf(t,e){let l=global.$db.Shelf.getStruct();if(l.name=e.shelfModel.name,e.shelfModel.id)await global.$db.Shelf.update({id:e.shelfModel.id},l);else{let n=await global.$db.Shelf.create(l),o=global.$db.Relation_AreaShelf.getStruct();o.areaId=e.areaId,o.shelfId=n.lastID,await global.$db.Relation_AreaShelf.create(o)}}async getShelfList(t,e){let l=[],n=await global.$db.Relation_AreaShelf.query({areaId:e.areaId});for(let o in n){let a=await global.$db.Shelf.get({id:n[o].shelfId});a&&l.push(a)}return l}async shelfDelete(t,e){await global.$db.Shelf.delete(e);let l=await global.$db.Relation_AreaShelf.query({shelfId:e});for(let o in l)await global.$db.Relation_AreaShelf.delete(l[o].id);let n=await global.$db.Relation_ShelfBook.query({shelfId:e});for(let o in n)await global.$db.Book.delete(n[o].bookId),await global.$db.Relation_ShelfBook.delete(n[o].id)}async commitBook(t,e){let l=global.$db.Book.getStruct();if(l.name=e.bookModel.name,l.content=e.bookModel.content,e.bookModel.id)await global.$db.Book.update({id:e.bookModel.id},l);else{let n=await global.$db.Book.create(l),o=global.$db.Relation_ShelfBook.getStruct();o.shelfId=e.shelfId,o.bookId=n.lastID,await global.$db.Relation_ShelfBook.create(o)}}async getBookList(t,e){let l=[],n=await global.$db.Relation_ShelfBook.query({shelfId:e.shelfId});for(let o in n){let a=await global.$db.Book.get({id:n[o].bookId});a&&l.push(a)}return l}async bookDelete(t,e){await global.$db.Book.delete(e);let l=await global.$db.Relation_ShelfBook.query({bookId:e});for(let n in l)await global.$db.Relation_ShelfBook.delete(l[n].id)}};u([d("\u77E5\u8BC6\u533A\u57DF\u63D0\u4EA4\u6210\u529F")],m.prototype,"commitArea",1),u([d("\u83B7\u53D6\u77E5\u8BC6\u5217\u8868\u6210\u529F")],m.prototype,"getAreaList",1),u([d("\u5220\u9664\u77E5\u8BC6\u533A\u57DF\u6210\u529F")],m.prototype,"areaDelete",1),u([d("\u63D0\u4EA4\u4E66\u67B6\u6210\u529F")],m.prototype,"commitShelf",1),u([d("\u83B7\u53D6\u4E66\u67B6\u5217\u8868\u6210\u529F")],m.prototype,"getShelfList",1),u([d("\u5220\u9664\u4E66\u67B6\u6210\u529F")],m.prototype,"shelfDelete",1),u([d("\u4E66\u7C4D\u63D0\u4EA4\u6210\u529F")],m.prototype,"commitBook",1),u([d("\u83B7\u53D6\u4E66\u7C4D\u5217\u8868\u6210\u529F")],m.prototype,"getBookList",1),u([d("\u5220\u9664\u4E66\u7C4D\u6210\u529F")],m.prototype,"bookDelete",1);var K=m;var v=global.$common.ElectronResponse,$=class{constructor(){}async commitLocalCmd(t,e){let l=global.$db.Cmds.getStruct();l.name=e.name,l.cmdString=e.cmdString,e.id?await global.$db.Cmds.update({id:e.id},l):await global.$db.Cmds.create(l)}async getLocalCmdList(){return await global.$db.Cmds.query()}async deleteLocalCmd(t,e){await global.$db.Cmds.delete(e)}};u([v("\u811A\u672C\u63D0\u4EA4\u6210\u529F")],$.prototype,"commitLocalCmd",1),u([v("\u83B7\u53D6\u811A\u672C\u5217\u8868\u6210\u529F")],$.prototype,"getLocalCmdList",1),u([v("\u5220\u9664\u811A\u672C\u6210\u529F")],$.prototype,"deleteLocalCmd",1);var V=$;var g;(function(i){i.WHITE="white",i.GREEN="green",i.YELLOW="yellow",i.RED="red"})(g||(g={}));function Z(i,t){if(i=i.replace(/\n/g," "),re(i)){let r=global.$common.getFullTime().full;t({pid:null,text:`@Node(${process.pid}) Danger Cmd: ${i}`,html:p(g.RED,`@Node(${process.pid}) Danger Cmd: ${i}`,r)});return}let e=require("child_process").exec(i,{maxBuffer:1024*1024*1024},(r,c,s)=>{let b=`@Node(${process.pid}) Cmd(${e.pid})`,h=global.$common.getFullTime().full,f={pid:null,text:`${b} Task end`,html:p(g.GREEN,b,`${b} Task end`,h)};r?(f.text=`${b} Command error:${r.message}`,f.html=p(g.RED,b,f.text,h)):s&&(f.text=`${b} Task error:${s.message}`,f.html=p(g.RED,b,f.text,h)),t(f)}),l="latin1";e.stdout.setEncoding(l);let n="utf8",o=`@Node(${process.pid}) Cmd(${e.pid}) Task start\uFF1A${l}=>${n}`,a=require("iconv-lite");return t({pid:e.pid,text:o,html:p(g.GREEN,o)}),e.stdout.on("data",r=>{let c=a.decode(Buffer.from(`@Log(${e.pid}) ${r}`,l),n);t({pid:e.pid,text:c,html:p(g.WHITE,c)}),r.includes("Merge conflict")&&P(e.pid)}),e.pid}function P(i){require("tree-kill")(i)}function re(i){i=i.trim().toUpperCase();let t=!1;return i.length===0&&(t=!0),i.indexOf("SSH")>=0&&(t=!0),t}function p(i,...t){let e="";return t.forEach(l=>e+=`<div style="color:${i}">${l}</div>`),e}var M=class{constructor(){}excuteLocalCmd(t,e){Z(e.command,l=>{t.reply("excuteLocalCmd",l)})}killLocalCmd(t,e){P(e.pid)}},X=M;async function se(){try{let i=require("path").join(process.cwd(),"../../Solomon.db"),t=new G;await t.dbLink(i),await t.dbTabler([{name:"Log",struct:{message:"string"}},{name:"Area",struct:{name:"string"}},{name:"Shelf",struct:{name:"string"}},{name:"Book",struct:{name:"string",content:"string"}},{name:"Relation_AreaShelf",struct:{areaId:"number",shelfId:"number"}},{name:"Relation_ShelfBook",struct:{shelfId:"number",bookId:"number"}},{name:"Cmds",struct:{name:"string",cmdString:"string"}}]),global.$common.bindClass(t,"Native",z),global.$common.bindClass(t,"Note",K),global.$common.bindClass(t,"Cmds",V),global.$common.bindClass(t,"CmdsAuto",X),global.Cabin=null,global.Cabin=t,t.electronRoute("openDevTool",global.Cabin.openDevTool),t.electronRoute("commitArea",global.Cabin.commitArea),t.electronRoute("getAreaList",global.Cabin.getAreaList),t.electronRoute("areaDelete",global.Cabin.areaDelete),t.electronRoute("commitShelf",global.Cabin.commitShelf),t.electronRoute("getShelfList",global.Cabin.getShelfList),t.electronRoute("shelfDelete",global.Cabin.shelfDelete),t.electronRoute("commitBook",global.Cabin.commitBook),t.electronRoute("getBookList",global.Cabin.getBookList),t.electronRoute("bookDelete",global.Cabin.bookDelete),t.electronRoute("commitLocalCmd",global.Cabin.commitLocalCmd),t.electronRoute("getLocalCmdList",global.Cabin.getLocalCmdList),t.electronRoute("deleteLocalCmd",global.Cabin.deleteLocalCmd),t.electronAliveRoute("excuteLocalCmd",global.Cabin.excuteLocalCmd),t.electronAliveRoute("killLocalCmd",global.Cabin.killLocalCmd)}catch(i){let t=`SolomonSDK error: ${i.message}`;global.$common.log(t),console.log(t),process.exit()}}se();
